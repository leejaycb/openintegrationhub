![prod](https://img.shields.io/badge/Status-Production-brightgreen.svg)

<p align="center">
  <img src="https://github.com/openintegrationhub/openintegrationhub/blob/master/Assets/medium-oih-einzeilig-zentriert.jpg" width="400"/>
</p>

The revolution in data synchronization — the Open Integration Hub enables simple data synchronization between any software applications and thus accelerates digitalisation

Visit the official [Open Integration Hub homepage](https://www.openintegrationhub.org/)

# IAM Service

IAM provides basic (token based) and advanced (OpenId-Connect compatible) Authentication, Authorization and User management as a service.

## General

There are two modes of authentication:

- Simple (which is called internally **basic** mode)
- OIDC (OpenId-Connect, **oidc**)

The default mode is **basic** which can be overridden with the **process.env.AUTH_TYPE** (see section **Configuration**)

==A default admin account is created on first start-up and printed to console. **You should modify the password after the setup, as this is a major security issue!**==

We currently use MongoDB as storage. The storage is abstracted through data access objects in src/dao directory. Our aim is to provide an interface to allow interchangeability of other storage-types via DAOs.

### Simple/Basic mode

In this mode the authentication/authorization is made via simple bearer tokens in the Authorization header. The tokens are issued by IAM either for any existing account.
The basic mode does not require HTTPS and can be used to bootstrap the project. The tokens can also be used for inter-service communication where each service receives an individual persistent token and uses this token for authorization with other services.

### OIDC mode

As OpenId-Connect provider we use this great implementation https://github.com/panva/node-oidc-provider

In order to get started, following steps should be considered:

- a RSA keystore will be auto-generated and stored in ProjectRootDir/keystore/keystore.json
  - You can also mount your own keystore by providing the the full path to file via **KEYSTORE_PATH** variable
- default client will be added, which can befound in src/oidc/util/clients/service-clients.js
  - you can provide the client password as an env variable **SERVICE_CLIENT_SECRET**
  - otherwise a default password will be auto generated on startup and logged to stdout
- a default _service account_ will be created
  - you can provide the default service account password as an env variable **SERVICE_ACCOUNT_PASSWORD**
  - otherwise a default password will be auto generated on startup and logged to stdout

#### Examples

Usage examples (e.g. create client, verify token, update account, revoke token, etc.) can be found in the _src/tasks/oidc_ directory as well as in unit/integration tests.

---

## Tokens (basic mode)

We use `crypto.randomBytes(128)` to generate secure tokens. There are two types of tokens: _ephemeral_ (temporary) and _persistent_.
On a successful login IAM creates a session cookie but also returns an ephemeral account token, which will automatically expire on inactivity or on a logout.
A persistent token can only be generated by a privileged account with an according permission. Persistent tokens do not expire automatically and are ideal to be passed as an environment variable to a service for inter-service communication.

Token validation can be done either manually by calling the `/api/v1/tokens/introspect` endpoint or via `iam-utils` npm-module, provided by OIH. This module provides an express middleware and a method to validate the token.

See _api-docs_ for more details (e.g. how to create a persistent token).

#### Login

POST **${BASE_URL}/login**

Login with username, password (JSON payload). A JSON containing the token will be returned.
Provide the token in future requests as a bearer token.

```shell
Authorization: Bearer ${TOKEN}
```

The token contains at least following claims:

- username
- permissions
- tenant

#### Refresh the token

GET **${BASE_URL}/token/refresh**

You must provide your current token as bearer token. The response will contain the new token. The TTL of the token can be configured via Env variable.

#### Further examples

Usage examples can be found in the _examples_ directory as well as in unit/integration tests.

---

## Permissions model

Each tenant can create custom roles and assign a set of permissions to that role. Additionally, each account can have any number of permissions assigned to it, independent from role(s).

There are two types of permissions – _restricted_ and _common_ permissions. Restricted permissions can only be set by an admin.

_Note_: during token introspection all account permissions (account bound and role permissions) will be concatenated into a single `permissions` array in the response body.

---

## Configuration

See the default config in src/config/index.js

The following list contains the environment variables you can set to configure the service:

- **IAM_BASEURL** - OIDC Prodiver base url. _default_: https://127.0.0.1:3099
- **IAM_APIBASE** - API Base, _default_: 'api/v1'
- **IAM_ORIGINWHITELIST** - you can provide a comma-separated list of origings, which should be allowed to access the provider. In development, this list is extended with '127.0.0.1,localhost'
- **IAM_AUTH_TYPE** - 'oidc' or 'basic'. _default_: oidc
- **IAM_DEBUG** - Boolean. _default_: false
- **IAM_PORT** - _default_: 3099
- **IAM_MONGODB_CONNECTION** - _default_: 'mongodb://localhost/accounts'
- **RABBITMQ_URI** - RabbitMQ for the OIH event bus; _default_: 'amqp://guest:guest@localhost:5672'
- **IAM_ACC_ADMIN_USERNAME** – default admin username
- **IAM_ACC_ADMIN_PASSWORD** – default admin password
- **IAM_ACC_SERVICEACCOUNT_USERNAME**
- **IAM_ACC_SERVICEACCOUNT_PASSWORD**
- **IAM_SESSION_COOKIE_SECRET** - Secret used to sign the session cookie
- **IAM_SESSION_COOKIE_NAME** - Session cookie name

- **IAM_OIDC_DBPREFIX** - _default_: oidc
- **IAM_OIDC_MAXAGE** - value in seconds. _default_: 1d in ms
- **IAM_OIDC_TTL_ACCESSTOKEN** - value in s. _default_: 1h
- **IAM_OIDC_TTL_AUTHCODE** - value in s. _default_: 10min
- **IAM_OIDC_TTL_CLIENTCRED** - value in s. _default_: 10min
- **IAM_OIDC_TTL_IDTOKEN** - value in s. _default_: 1h
- **IAM_OIDC_TTL_REFRESHTOKEN** - value in s. _default_: 1d
- **IAM_OIDC_TTL_REGACCESSTOKEN** - value in s. _default_: 1d
- **KEYSTORE_PATH** - Full path to a keystore. If no path is provided, keystore will be auto generated and saved in project root. ==You should always mount a directory and provide a full path to a json file, where the keys should be read and stored.==

---

## Minimal Setup / Local development

- Create a MongoDB Database
- Run `npm install` to install all dependencies
- Rename the provided _nodemon_example.json_ to _nodemon.json_
- Run `npm run watch` to start the service locally

---

## REST-API documentation

Visit the route **${BASE_URL}/api-docs** to view the Swagger API documentation.

---

## Usage

### Login

POST: /login (see open api docs)

### Tokens

#### Create a token

POST /api/v1/tokens (see open api docs)

_If you want to create a permanent token, pass an "expiresIn" value of -1_

#### Introspect a token

POST /api/v1/tokens/introspect (see open api docs)

---

## Operations

- This service can run in a replica set and has no session stickiness
- All sessions are stored in the database, which should allow a HA setup

- we provide a basic Configuration for Kubernetes under /k8s

The Kubernetes YAML's (deployment and Service) relay on Secrets which need to created first and we RECOMMEND to use HASHES for the Secret Strings and  
policy proved Passwords for the Admin and Service Account.

1. mongosecret-oih-iam  
   1.1  
   key/value  
   url = 'mongodb://USERNAME:PASSWORD@MONGOSERVER1:27017,MONGOSERVER2:27017,MONGOSERVER3:27017/accounts?ssl=true&replicaSet=NAME&authSource=admin'

2. oidc-oih-iam-dev  
   2.1  
   key/value
   jwtsecret = 'somestring'  
   cookiesecrets = 'somestring'  
   ADMIN_PASSWORD = 'somestring'  
   serviceaccpass = 'somestring'  
   client-secret = 'somestring'

3. oidc-certs
   3.1  
   Filename: keystore.json  
   step1: navigate in the Repo folder to `services/iam`
   step2: execute `npm i`
   step3: execute `node -e "require('./src/util/keystore').generateFile()"`
   step4: upload `./keystore/keystore.json` as K8S secret to the correct namspace with
   `kubectl -n NAMESPACE create secret generic oidc-certs --from-file=keystore.json='./keystore/keystore.json'`

## Useful commands

### Generate keystore

```zsh
npm run generate-keystore
```

### Run tasks as examples

Start local iam

```zsh
npm run watch
```

Run a task

```zsh
npm run task <path-to-example>
```

```zsh
npm run task ./src/tasks/oidc/update-user
```

- **PORT** - defaults to 3099
- **IAM_BASEURL** - i.e. "https://127.0.0.1:3099"
- **IAM_SERVICE_CLIENT_ID** - xxx
- **IAM_SERVICE_CLIENT_SECRET** - xxx
- **AUTH_TYPE** - "basic" or "oidc"
- **IAM_ACC_ADMIN_USERNAME** - xxx
- **IAM_ACC_ADMIN_PASSWORD** - xxx
- **DEBUG** - true/false

## Build Docker and push to registry

docker build -t eu.gcr.io/${GCP_PROJECT_ID}/iam
gcloud docker -- push eu.gcr.io/${GCP_PROJECT_ID}/iam

## Test run

docker run --rm -ti -v $PWD/uploads:/home/uploads --name -p 80:3099 iam eu.gcr.io/${GCP_PROJECT_ID}/iam
